<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0d1b3e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Strecken">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Fahrtenbuch</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: #0d1b3e;
    color: #111;
    min-height: 100vh;
    min-height: 100dvh;
    padding: 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
  }

  .card {
    background: #fff;
    border-radius: 14px;
    padding: 24px;
    width: 100%;
    max-width: 520px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.35);
  }

  /* â”€â”€ Header â”€â”€ */
  .app-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  h1 {
    font-family: 'Space Mono', monospace;
    font-size: 0.9rem;
    letter-spacing: 0.1em;
    color: #0d1b3e;
    text-transform: uppercase;
  }

  .tab-bar {
    display: flex;
    background: #f0f3fa;
    border-radius: 8px;
    padding: 3px;
    gap: 2px;
  }

  .tab {
    flex: 1;
    padding: 7px 12px;
    border: none;
    background: none;
    border-radius: 6px;
    font-family: 'Space Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: #6b7a9e;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .tab.active { background: #0d1b3e; color: #fff; }

  /* â”€â”€ Views â”€â”€ */
  .view { display: none; flex-direction: column; gap: 14px; }
  .view.active { display: flex; }

  /* â”€â”€ Field label â”€â”€ */
  .field-label {
    font-family: 'Space Mono', monospace;
    font-size: 0.6rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: #6b7a9e;
    margin-bottom: 6px;
  }

  /* â”€â”€ Stop rows â”€â”€ */
  .stops-list { display: flex; flex-direction: column; gap: 7px; }
  .stop-row { display: flex; align-items: center; gap: 5px; }

  .stop-num {
    font-family: 'Space Mono', monospace;
    font-size: 0.6rem;
    color: #9aa5c0;
    width: 14px;
    text-align: right;
    flex-shrink: 0;
  }

  input[type="date"] {
    background: #f0f3fa;
    border: 1.5px solid #d0d8ed;
    color: #444;
    padding: 9px 6px;
    font-family: 'Space Mono', monospace;
    font-size: 0.64rem;
    border-radius: 6px;
    outline: none;
    width: 110px;
    flex-shrink: 0;
    color-scheme: light;
    transition: border-color 0.2s;
  }
  input[type="date"]:focus { border-color: #0d1b3e; }

  input[type="text"] {
    flex: 1;
    background: #f0f3fa;
    border: 1.5px solid #d0d8ed;
    color: #111;
    padding: 9px 10px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.88rem;
    border-radius: 6px;
    outline: none;
    min-width: 0;
    transition: border-color 0.2s;
  }
  input[type="text"]:focus { border-color: #0d1b3e; }

  .icon-btn {
    background: #f0f3fa;
    border: 1.5px solid #d0d8ed;
    color: #6b7a9e;
    width: 32px; height: 32px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    transition: all 0.15s;
    -webkit-tap-highlight-color: transparent;
  }
  .icon-btn:active { border-color: #0d1b3e; color: #0d1b3e; background: #e4eaf7; }
  .icon-btn.remove:active { border-color: #c0392b; color: #c0392b; background: #fff0ee; }

  .add-btn {
    background: none;
    border: 1.5px dashed #b0bcda;
    color: #8a96b5;
    padding: 9px;
    border-radius: 6px;
    cursor: pointer;
    font-family: 'Space Mono', monospace;
    font-size: 0.68rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    width: 100%;
    transition: all 0.15s;
    margin-top: 4px;
  }
  .add-btn:active { border-color: #0d1b3e; color: #0d1b3e; }

  /* â”€â”€ Buttons â”€â”€ */
  .btn-row { display: flex; gap: 8px; }

  .btn-primary {
    flex: 1;
    padding: 13px;
    background: #1a6b3c;
    color: #fff;
    border: none;
    border-radius: 6px;
    font-family: 'Space Mono', monospace;
    font-weight: 700;
    font-size: 0.75rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    cursor: pointer;
    transition: background 0.15s;
  }
  .btn-primary:active { background: #145530; }
  .btn-primary:disabled { opacity: 0.4; }

  .btn-reset {
    padding: 13px 14px;
    background: none;
    border: 1.5px solid #d0d8ed;
    color: #6b7a9e;
    border-radius: 6px;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.15s;
    flex-shrink: 0;
  }
  .btn-reset:active { border-color: #0d1b3e; color: #0d1b3e; background: #f0f3fa; }


  /* â”€â”€ Spinner / Error â”€â”€ */
  .spinner {
    display: none;
    width: 18px; height: 18px;
    border: 2px solid #d0d8ed;
    border-top-color: #0d1b3e;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    margin: 0 auto;
  }
  .spinner.show { display: block; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .msg {
    padding: 10px 14px;
    border-radius: 6px;
    font-size: 0.82rem;
    display: none;
  }
  .msg.show { display: block; }
  .msg.error { background: #fff0ee; border: 1.5px solid #e8b4af; color: #c0392b; }
  .msg.success { background: #e8f5e9; border: 1.5px solid #81c784; color: #2e7d32; }

  /* â”€â”€ Result segments â”€â”€ */
  .results { display: none; flex-direction: column; gap: 7px; }
  .results.show { display: flex; }

  .seg-row {
    background: #f0f3fa;
    border: 1.5px solid #d0d8ed;
    border-radius: 6px;
    padding: 9px 13px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
  }
  .seg-label { font-size: 0.8rem; color: #222; flex: 1; min-width: 0; overflow: hidden; }
  .seg-label .route { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .seg-label .arrow { color: #9aa5c0; margin: 0 3px; }
  .seg-label .seg-date { font-family: 'Space Mono', monospace; font-size: 0.58rem; color: #8a96b5; margin-top: 2px; }
  .seg-km { font-family: 'Space Mono', monospace; font-size: 0.82rem; font-weight: 700; color: #0d1b3e; flex-shrink: 0; }

  .total-bar {
    background: #0d1b3e;
    border-radius: 6px;
    padding: 11px 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .total-bar .lbl { font-family: 'Space Mono', monospace; font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; color: #7a92c4; }
  .total-bar .val { font-family: 'Space Mono', monospace; font-size: 0.95rem; font-weight: 700; color: #fff; }

  hr { border: none; border-top: 1.5px solid #e8ecf5; }

  /* â”€â”€ History view â”€â”€ */
  .history-controls {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  select {
    flex: 1;
    background: #f0f3fa;
    border: 1.5px solid #d0d8ed;
    color: #111;
    padding: 9px 10px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.88rem;
    border-radius: 6px;
    outline: none;
  }

  .btn-export {
    padding: 9px 14px;
    background: #1a6b3c;
    color: #fff;
    border: none;
    border-radius: 6px;
    font-family: 'Space Mono', monospace;
    font-weight: 700;
    font-size: 0.7rem;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    cursor: pointer;
    white-space: nowrap;
  }
  .btn-export:active { background: #145530; }

  .btn-danger {
    padding: 9px 12px;
    background: none;
    border: 1.5px solid #e8b4af;
    color: #c0392b;
    border-radius: 6px;
    font-family: 'Space Mono', monospace;
    font-size: 0.7rem;
    cursor: pointer;
    white-space: nowrap;
  }

  .history-list { display: flex; flex-direction: column; gap: 10px; }

  .day-block {
    border: 1.5px solid #d0d8ed;
    border-radius: 8px;
    overflow: hidden;
  }

  .day-header {
    background: #0d1b3e;
    padding: 8px 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .day-header .day-date { font-family: 'Space Mono', monospace; font-size: 0.72rem; color: #fff; }
  .day-header .day-km { font-family: 'Space Mono', monospace; font-size: 0.72rem; font-weight: 700; color: #7eb8f7; }

  .day-segs { padding: 8px 0; }

  .hist-seg {
    padding: 6px 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.8rem;
    color: #333;
    border-bottom: 1px solid #f0f3fa;
  }
  .hist-seg:last-child { border-bottom: none; }
  .hist-seg .route { color: #555; }
  .hist-seg .arrow { color: #b0bcda; margin: 0 4px; }
  .hist-seg .km { font-family: 'Space Mono', monospace; font-size: 0.75rem; font-weight: 700; color: #0d1b3e; flex-shrink: 0; }

  .month-total {
    background: rgba(13,27,62,0.06);
    border-radius: 8px;
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .month-total .lbl { font-family: 'Space Mono', monospace; font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; color: #6b7a9e; }
  .month-total .val { font-family: 'Space Mono', monospace; font-size: 1rem; font-weight: 700; color: #0d1b3e; }

  .empty-state {
    text-align: center;
    padding: 32px 16px;
    color: #9aa5c0;
    font-size: 0.85rem;
    line-height: 1.6;
  }

  /* â”€â”€ QR Modal â”€â”€ */
  .qr-modal {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.85); z-index: 1000;
    align-items: center; justify-content: center;
  }
  .qr-modal.show { display: flex; }
  .qr-box {
    background: #fff; border-radius: 12px; padding: 22px;
    display: flex; flex-direction: column; align-items: center;
    gap: 12px; max-width: 320px; width: 90%;
  }
  .qr-title { font-family: 'Space Mono', monospace; font-size: 0.78rem; letter-spacing: 0.08em; text-transform: uppercase; color: #0d1b3e; }
  #qrVideo { width: 100%; border-radius: 8px; border: 2px solid #d0d8ed; background: #000; }
  .qr-hint { font-size: 0.76rem; color: #6b7a9e; text-align: center; line-height: 1.5; }
  .qr-cancel { background: none; border: 1.5px solid #d0d8ed; color: #6b7a9e; padding: 7px 18px; border-radius: 6px; cursor: pointer; font-family: 'Space Mono', monospace; font-size: 0.7rem; text-transform: uppercase; }
  .qr-fb { padding: 7px 14px; border-radius: 6px; font-size: 0.8rem; display: none; text-align: center; width: 100%; }
  .qr-fb.show { display: block; }
  .qr-fb.ok { background: #e8f5e9; border: 1.5px solid #81c784; color: #2e7d32; }
  .qr-fb.err { background: #fff0ee; border: 1.5px solid #e8b4af; color: #c0392b; }
</style>
</head>
<body>

<div class="card">
  <!-- Header + Tabs -->
  <div class="app-header">
    <h1>Fahrtenbuch</h1>
    <div class="tab-bar">
      <button class="tab active" data-tab="eingabe">Eingabe</button>
      <button class="tab" data-tab="verlauf">Verlauf</button>
    </div>
  </div>

  <!-- â•â• EINGABE VIEW â•â• -->
  <div class="view active" id="tab-eingabe">
    <div>
      <div class="field-label">Haltepunkte</div>
      <div class="stops-list" id="stopsList"></div>
      <button class="add-btn" id="addBtn">+ Haltepunkt hinzufÃ¼gen</button>
    </div>

    <hr>

    <div class="btn-row">
      <button class="btn-primary" id="saveBtn">ðŸ’¾ Speichern</button>
      <button class="btn-reset" id="resetBtn" title="Formular zurÃ¼cksetzen">â†º</button>
    </div>
    <div class="spinner" id="spinner"></div>
    <div class="msg error" id="errorMsg"></div>
    <div class="msg success" id="successMsg"></div>

    <div class="results" id="results"></div>
  </div>

  <!-- â•â• VERLAUF VIEW â•â• -->
  <div class="view" id="tab-verlauf">
    <div class="history-controls">
      <select id="monthSelect"></select>
      <button class="btn-export" id="exportBtn">â¬‡ Excel</button>
      <button class="btn-danger" id="clearMonthBtn">ðŸ—‘</button>
    </div>
    <div class="history-list" id="historyList"></div>
  </div>
</div>

<!-- QR Modal -->
<div class="qr-modal" id="qrModal">
  <div class="qr-box">
    <div class="qr-title">QR-Code scannen</div>
    <video id="qrVideo" autoplay playsinline muted></video>
    <canvas id="qrCanvas" style="display:none"></canvas>
    <div class="qr-hint">Halte einen QR-Code mit einem Ortsnamen in die Kamera.</div>
    <div class="qr-fb" id="qrFb"></div>
    <button class="qr-cancel" id="qrCancel">Abbrechen</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVICE WORKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(() => {});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE  (IndexedDB-style via localStorage)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STORE_KEY = 'fahrtenbuch_v1';

function loadAllTrips() {
  try { return JSON.parse(localStorage.getItem(STORE_KEY)) || []; }
  catch { return []; }
}

function saveAllTrips(trips) {
  localStorage.setItem(STORE_KEY, JSON.stringify(trips));
}

function segKey(seg) {
  return seg.date + '|' + seg.von + '|' + seg.nach + '|' + seg.km;
}

function saveTrip(trip) {
  const existing = loadAllTrips();

  // Build fingerprint set of all already-stored segments
  const stored = new Set();
  existing.forEach(t => t.segments.forEach(s => stored.add(segKey(s))));

  // Filter out duplicates
  const newSegs = trip.segments.filter(s => !stored.has(segKey(s)));

  if (newSegs.length === 0) return 'duplicate';

  existing.push(Object.assign({}, trip, { segments: newSegs }));
  saveAllTrips(existing);
  return 'saved';
}

function deleteTripsForMonth(monthKey) {
  const trips = loadAllTrips().filter(t => t.monthKey !== monthKey);
  saveAllTrips(trips);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.tab').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    if (btn.dataset.tab === 'verlauf') renderHistory();
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STOPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let stopCount = 0;

function todayISO() {
  const d = new Date();
  return d.toISOString().slice(0, 10);
}

function getLastDate() {
  const dates = [...document.querySelectorAll('.stop-row input[type="date"]')];
  for (let i = dates.length - 1; i >= 0; i--) {
    if (dates[i].value) return dates[i].value;
  }
  return todayISO();
}

// QR icon as inline SVG
const QR_ICON = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
  <rect x="5" y="5" width="3" height="3" fill="currentColor" stroke="none"/><rect x="16" y="5" width="3" height="3" fill="currentColor" stroke="none"/><rect x="5" y="16" width="3" height="3" fill="currentColor" stroke="none"/>
  <line x1="14" y1="14" x2="14" y2="14"/><line x1="17" y1="14" x2="17" y2="14"/><line x1="20" y1="14" x2="20" y2="14"/>
  <line x1="14" y1="17" x2="14" y2="17"/><line x1="17" y1="17" x2="20" y2="17"/><line x1="20" y1="20" x2="14" y2="20"/>
  <line x1="14" y1="20" x2="14" y2="17"/>
</svg>`;

function addStop(placeholder, isFirst) {
  stopCount++;
  const list = document.getElementById('stopsList');
  const row = document.createElement('div');
  row.className = 'stop-row';
  row.innerHTML = `
    <span class="stop-num">${list.children.length + 1}</span>
    <input type="date" />
    <input type="text" placeholder="${placeholder || 'Ort eingeben'}" autocomplete="off" />
    <button class="icon-btn qr-btn" title="QR scannen">${QR_ICON}</button>
    <button class="icon-btn remove" title="Entfernen">&#x00D7;</button>
  `;

  // Set date: first stop gets today, others inherit from previous
  const dateInput = row.querySelector('input[type="date"]');
  dateInput.value = getLastDate();

  // When date changes â†’ propagate to all following stops
  dateInput.addEventListener('change', () => {
    const allRows = [...document.querySelectorAll('.stop-row')];
    const idx = allRows.indexOf(row);
    for (let i = idx + 1; i < allRows.length; i++) {
      allRows[i].querySelector('input[type="date"]').value = dateInput.value;
    }
  });

  // Remove button â€“ always works, but keeps minimum 2 stops
  row.querySelector('.remove').addEventListener('click', () => {
    const list = document.getElementById('stopsList');
    if (list.children.length > 2) {
      row.remove();
      updateNumbers();
    }
  });

  row.querySelector('.qr-btn').addEventListener('click', () => {
    activeInput = row.querySelector('input[type="text"]');
    openQR();
  });

  row.querySelector('input[type="text"]').addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      const inputs = [...document.querySelectorAll('.stop-row input[type="text"]')];
      const idx = inputs.indexOf(e.target);
      if (idx < inputs.length - 1) inputs[idx + 1].focus();
      else document.getElementById('calcBtn').click();
    }
  });

  list.appendChild(row);
  updateNumbers();
}

function updateNumbers() {
  document.querySelectorAll('.stop-row').forEach((row, i) => {
    row.querySelector('.stop-num').textContent = i + 1;
  });
}

function resetForm() {
  document.getElementById('stopsList').innerHTML = '';
  stopCount = 0;
  addStop('Startpunkt', true);
  addStop('Endpunkt');
  document.getElementById('results').classList.remove('show');
  document.getElementById('results').innerHTML = '';
  document.getElementById('errorMsg').classList.remove('show');
  document.getElementById('successMsg').classList.remove('show');
  pendingTrip = null;
}

addStop('Startpunkt', true);
addStop('Endpunkt');
document.getElementById('addBtn').addEventListener('click', () => addStop('Zwischenstopp'));
document.getElementById('resetBtn').addEventListener('click', resetForm);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QR SCANNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let activeInput = null, scanInterval = null, camStream = null;

function openQR() {
  document.getElementById('qrModal').classList.add('show');
  document.getElementById('qrFb').classList.remove('show');
  startCam();
}
function closeQR() {
  document.getElementById('qrModal').classList.remove('show');
  stopCam();
}
async function startCam() {
  try {
    camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    const v = document.getElementById('qrVideo');
    v.srcObject = camStream; v.play();
    v.addEventListener('loadedmetadata', () => { scanInterval = setInterval(scanFrame, 200); }, { once: true });
  } catch(e) {
    showQrFb('Kamera nicht verfÃ¼gbar: ' + e.message, false);
  }
}
function stopCam() {
  clearInterval(scanInterval); scanInterval = null;
  if (camStream) { camStream.getTracks().forEach(t => t.stop()); camStream = null; }
}
function scanFrame() {
  const v = document.getElementById('qrVideo'), c = document.getElementById('qrCanvas');
  if (v.readyState !== v.HAVE_ENOUGH_DATA) return;
  c.width = v.videoWidth; c.height = v.videoHeight;
  const ctx = c.getContext('2d');
  ctx.drawImage(v, 0, 0, c.width, c.height);
  const code = jsQR(ctx.getImageData(0, 0, c.width, c.height).data, c.width, c.height);
  if (code && code.data.trim()) {
    if (activeInput) activeInput.value = code.data.trim();
    showQrFb('âœ“ ' + code.data.trim(), true);
    stopCam();
    setTimeout(closeQR, 1200);
  }
}
function showQrFb(msg, ok) {
  const el = document.getElementById('qrFb');
  el.textContent = msg;
  el.className = 'qr-fb show ' + (ok ? 'ok' : 'err');
}
document.getElementById('qrCancel').addEventListener('click', closeQR);
document.getElementById('qrModal').addEventListener('click', e => { if (e.target.id === 'qrModal') closeQR(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GEOCODE + ROUTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function geocode(q) {
  const r = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&limit=1`, { headers: { 'Accept-Language': 'de' } });
  const d = await r.json();
  if (!d.length) throw new Error(`Ort nicht gefunden: "${q}"`);
  return { lat: parseFloat(d[0].lat), lon: parseFloat(d[0].lon), name: d[0].display_name.split(',')[0].trim() };
}

async function getKm(from, to) {
  const r = await fetch(`https://router.project-osrm.org/route/v1/car/${from.lon},${from.lat};${to.lon},${to.lat}?overview=false`);
  const d = await r.json();
  if (d.code !== 'Ok') throw new Error(`Keine Route: ${from.name} â†’ ${to.name}`);
  return d.routes[0].distance / 1000;
}

function fmtKm(km) { return km.toFixed(1) + ' km'; }
function fmtDate(iso) { if (!iso) return ''; const [y,m,d] = iso.split('-'); return `${d}.${m}.${y}`; }
function monthKey(iso) { if (!iso) return ''; return iso.slice(0, 7); } // "2025-03"
function monthLabel(key) {
  if (!key) return '';
  const [y, m] = key.split('-');
  const names = ['Jan','Feb','MÃ¤r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
  return names[parseInt(m)-1] + ' ' + y;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE (berechnet automatisch im Hintergrund)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pendingTrip = null;

document.getElementById('saveBtn').addEventListener('click', async () => {
  const rows = [...document.querySelectorAll('.stop-row')];
  const locs = rows.map(r => r.querySelector('input[type="text"]').value.trim());
  const dates = rows.map(r => r.querySelector('input[type="date"]').value);

  const errEl = document.getElementById('errorMsg');
  const sucEl = document.getElementById('successMsg');
  const resEl = document.getElementById('results');
  const saveBtn = document.getElementById('saveBtn');
  const spin = document.getElementById('spinner');

  errEl.classList.remove('show'); sucEl.classList.remove('show');
  resEl.classList.remove('show'); resEl.innerHTML = '';

  if (locs.some(v => !v)) { errEl.textContent = 'Bitte alle Ortsfelder ausfÃ¼llen.'; errEl.classList.add('show'); return; }
  if (dates.some(v => !v)) { errEl.textContent = 'Bitte alle Datumsfelder ausfÃ¼llen.'; errEl.classList.add('show'); return; }

  saveBtn.disabled = true;
  spin.classList.add('show');

  try {
    const places = await Promise.all(locs.map(geocode));
    const segments = [];
    let total = 0;

    for (let i = 0; i < places.length - 1; i++) {
      const km = await getKm(places[i], places[i+1]);
      segments.push({
        date: dates[i],
        von: places[i].name,
        nach: places[i+1].name,
        km: parseFloat(km.toFixed(1))
      });
      total += km;

      // Show result informativ
      const row = document.createElement('div');
      row.className = 'seg-row';
      row.innerHTML = `
        <div class="seg-label">
          <div class="route">${places[i].name}<span class="arrow">â†’</span>${places[i+1].name}</div>
          <div class="seg-date">${fmtDate(dates[i])} â†’ ${fmtDate(dates[i+1])}</div>
        </div>
        <div class="seg-km">${fmtKm(km)}</div>
      `;
      resEl.appendChild(row);
    }

    if (segments.length > 1) {
      const bar = document.createElement('div');
      bar.className = 'total-bar';
      bar.innerHTML = `<span class="lbl">Gesamt</span><span class="val">${fmtKm(total)}</span>`;
      resEl.appendChild(bar);
    }

    resEl.classList.add('show');

    // Direkt speichern â€“ Duplikate werden automatisch herausgefiltert
    const result = saveTrip({ segments, savedAt: new Date().toISOString(), monthKey: monthKey(dates[0]) });

    if (result === 'duplicate') {
      sucEl.textContent = 'â„¹ï¸ Alle EintrÃ¤ge bereits vorhanden â€“ nichts Neues gespeichert.';
    } else {
      sucEl.textContent = 'âœ“ Fahrt gespeichert!';
    }
    sucEl.classList.add('show');

    setTimeout(() => {
      sucEl.classList.remove('show');
      resetForm();
    }, 2200);

  } catch(e) {
    errEl.textContent = e.message;
    errEl.classList.add('show');
  } finally {
    saveBtn.disabled = false;
    spin.classList.remove('show');
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getAvailableMonths() {
  const trips = loadAllTrips();
  const keys = [...new Set(trips.map(t => t.monthKey))].sort().reverse();
  return keys;
}

function renderHistory() {
  const months = getAvailableMonths();
  const sel = document.getElementById('monthSelect');
  const current = sel.value;

  sel.innerHTML = months.length
    ? months.map(k => `<option value="${k}" ${k===current?'selected':''}>${monthLabel(k)}</option>`).join('')
    : '<option value="">Keine EintrÃ¤ge</option>';

  renderMonth(sel.value);
}

function renderMonth(key) {
  const list = document.getElementById('historyList');
  list.innerHTML = '';

  if (!key) {
    list.innerHTML = '<div class="empty-state">Noch keine Fahrten gespeichert.<br>Berechne und speichere deine erste Fahrt.</div>';
    return;
  }

  const trips = loadAllTrips().filter(t => t.monthKey === key);
  if (!trips.length) {
    list.innerHTML = '<div class="empty-state">Keine EintrÃ¤ge fÃ¼r diesen Monat.</div>';
    return;
  }

  // Flatten all segments and group by date
  const byDate = {};
  trips.forEach(trip => {
    trip.segments.forEach(seg => {
      if (!byDate[seg.date]) byDate[seg.date] = [];
      byDate[seg.date].push(seg);
    });
  });

  const sortedDates = Object.keys(byDate).sort();
  let monthTotal = 0;

  sortedDates.forEach(date => {
    const segs = byDate[date];
    const dayTotal = segs.reduce((s, seg) => s + seg.km, 0);
    monthTotal += dayTotal;

    const block = document.createElement('div');
    block.className = 'day-block';
    block.innerHTML = `
      <div class="day-header">
        <span class="day-date">${fmtDate(date)}</span>
        <span class="day-km">${fmtKm(dayTotal)}</span>
      </div>
      <div class="day-segs">
        ${segs.map(seg => `
          <div class="hist-seg">
            <span class="route">${seg.von}<span class="arrow">â†’</span>${seg.nach}</span>
            <span class="km">${fmtKm(seg.km)}</span>
          </div>
        `).join('')}
      </div>
    `;
    list.appendChild(block);
  });

  // Month total
  const totalEl = document.createElement('div');
  totalEl.className = 'month-total';
  totalEl.innerHTML = `<span class="lbl">${monthLabel(key)} gesamt</span><span class="val">${fmtKm(monthTotal)}</span>`;
  list.appendChild(totalEl);
}

document.getElementById('monthSelect').addEventListener('change', e => renderMonth(e.target.value));

document.getElementById('clearMonthBtn').addEventListener('click', () => {
  const key = document.getElementById('monthSelect').value;
  if (!key) return;
  if (confirm(`Alle EintrÃ¤ge fÃ¼r ${monthLabel(key)} lÃ¶schen?`)) {
    deleteTripsForMonth(key);
    renderHistory();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXCEL EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('exportBtn').addEventListener('click', () => {
  const key = document.getElementById('monthSelect').value;
  if (!key) return;

  const trips = loadAllTrips().filter(t => t.monthKey === key);
  if (!trips.length) return;

  // Build flat segment list grouped by date
  const byDate = {};
  trips.forEach(trip => {
    trip.segments.forEach(seg => {
      if (!byDate[seg.date]) byDate[seg.date] = [];
      byDate[seg.date].push(seg);
    });
  });

  const rows = [];
  let monthTotal = 0;

  Object.keys(byDate).sort().forEach(date => {
    const segs = byDate[date];
    const dayTotal = segs.reduce((s, seg) => s + seg.km, 0);

    segs.forEach((seg, i) => {
      rows.push({
        'Datum':              fmtDate(date),
        'Von':                seg.von,
        'Nach':               seg.nach,
        'Kilometer':          seg.km,
        'Tages-Gesamt (km)':  i === segs.length - 1 ? parseFloat(dayTotal.toFixed(1)) : ''
      });
    });

    // Empty separator row between days
    rows.push({ 'Datum': '', 'Von': '', 'Nach': '', 'Kilometer': '', 'Tages-Gesamt (km)': '' });
    monthTotal += dayTotal;
  });

  // Month total row
  rows.push({
    'Datum':             monthLabel(key) + ' GESAMT',
    'Von':               '',
    'Nach':              '',
    'Kilometer':         '',
    'Tages-Gesamt (km)': parseFloat(monthTotal.toFixed(1))
  });

  const ws = XLSX.utils.json_to_sheet(rows);
  ws['!cols'] = [{ wch: 12 }, { wch: 24 }, { wch: 24 }, { wch: 12 }, { wch: 18 }];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, monthLabel(key));
  XLSX.writeFile(wb, `fahrtenbuch_${key}.xlsx`);
});
</script>
</body>
</html>
