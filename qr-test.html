<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Test</title>
<style>
  body { font-family: Arial, sans-serif; background: #0d1b3e; color: #fff; padding: 16px; }
  button { width: 100%; padding: 14px; background: #fff; color: #0d1b3e; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; margin-bottom: 12px; cursor: pointer; }
  video { width: 100%; border-radius: 8px; background: #000; display: block; margin-bottom: 8px; max-height: 60vw; object-fit: cover; }
  #log { background: #1a2a4e; border-radius: 8px; padding: 12px; font-size: 0.78rem; line-height: 1.8; min-height: 80px; word-break: break-all; }
  .ok  { color: #6effa0; }
  .err { color: #ff8080; }
  .inf { color: #aac4ff; }
  #result { background: #1a6b3c; border-radius: 8px; padding: 12px; margin-bottom: 12px; display: none; font-size: 1rem; }
</style>
</head>
<body>
<h2 style="margin-bottom:16px">QR Scanner Test</h2>
<button id="startBtn">Kamera starten</button>
<button id="stopBtn" style="display:none;background:#c0392b;color:white">Stopp</button>
<video id="v" autoplay playsinline muted></video>
<div id="result"></div>
<div id="log"><div class="inf">Warte auf Start...</div></div>

<script>
let stream = null, detector = null, scanLoop = null;
const v = document.getElementById('v');
const logEl = document.getElementById('log');
const resultEl = document.getElementById('result');

function log(msg, type) {
  const line = document.createElement('div');
  line.className = type || 'inf';
  line.textContent = new Date().toLocaleTimeString() + ' – ' + msg;
  logEl.prepend(line);
  while (logEl.children.length > 25) logEl.removeChild(logEl.lastChild);
}

document.getElementById('startBtn').addEventListener('click', async () => {
  resultEl.style.display = 'none';

  // Check BarcodeDetector
  if (!('BarcodeDetector' in window)) {
    log('BarcodeDetector NICHT verfügbar in diesem Browser!', 'err');
    log('Android Chrome 83+ wird benötigt.', 'err');
    return;
  }
  log('BarcodeDetector: verfügbar', 'ok');

  // Check supported formats
  try {
    const formats = await BarcodeDetector.getSupportedFormats();
    log('Formate: ' + formats.join(', '), 'ok');
    if (!formats.includes('qr_code')) {
      log('WARNUNG: qr_code nicht in unterstützten Formaten!', 'err');
    }
  } catch(e) {
    log('getSupportedFormats Fehler: ' + e.message, 'err');
  }

  // Start camera
  const tries = [
    { video: { facingMode: { exact: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } } },
    { video: { facingMode: 'environment' } },
    { video: true }
  ];

  for (let i = 0; i < tries.length; i++) {
    try {
      stream = await navigator.mediaDevices.getUserMedia(tries[i]);
      log('Kamera gestartet (Option ' + (i+1) + ')', 'ok');
      break;
    } catch(e) {
      log('Option ' + (i+1) + ' fehlgeschlagen: ' + e.message, 'err');
      stream = null;
    }
  }

  if (!stream) { log('Keine Kamera verfügbar!', 'err'); return; }

  v.srcObject = stream;
  try { await v.play(); log('Video spielt', 'ok'); } catch(e) { log('Play-Fehler: ' + e.message, 'err'); }

  // Wait for dimensions
  await new Promise(res => {
    const check = () => {
      if (v.videoWidth > 0) { res(); }
      else setTimeout(check, 100);
    };
    check();
  });
  log('Video-Größe: ' + v.videoWidth + 'x' + v.videoHeight, 'ok');

  // Create detector
  detector = new BarcodeDetector({ formats: ['qr_code'] });
  log('Scan gestartet – QR-Code vorhalten...', 'ok');

  let frameCount = 0;
  scanLoop = setInterval(async () => {
    if (!stream || v.paused || !v.videoWidth) return;
    frameCount++;
    if (frameCount % 10 === 0) log('Frames: ' + frameCount);
    try {
      const codes = await detector.detect(v);
      if (codes.length > 0) {
        const val = codes[0].rawValue;
        log('QR ERKANNT: ' + val, 'ok');
        resultEl.textContent = '✓ ' + val;
        resultEl.style.display = 'block';
        stopAll();
      }
    } catch(e) {
      log('detect() Fehler: ' + e.message, 'err');
    }
  }, 300);

  document.getElementById('startBtn').style.display = 'none';
  document.getElementById('stopBtn').style.display = 'block';
});

document.getElementById('stopBtn').addEventListener('click', stopAll);

function stopAll() {
  if (scanLoop) { clearInterval(scanLoop); scanLoop = null; }
  if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
  v.srcObject = null;
  document.getElementById('startBtn').style.display = 'block';
  document.getElementById('stopBtn').style.display = 'none';
  log('Gestoppt');
}
</script>
</body>
</html>